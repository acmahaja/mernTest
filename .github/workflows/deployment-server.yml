name: deploy
on: [push]
env:
  PROJECT_ID: ${{secrets.PROJECT_ID}} 
  SERVICE: server
  REGION: us-east-1

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: 'actions/checkout@v3'

    - name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'


    - name: Deploy to Cloud Run
      id: deploy
      uses: google-github-actions/deploy-cloudrun@v0
      with:
        service: ${{ env.SERVICE }}
        region: ${{ env.REGION }}
        source: ./server

    # If required, use the Cloud Run url output in later steps
    - name: Show Output
      run: echo ${{ steps.deploy.outputs.url }}

# name: deploy
# on: [push]

# env:
#   SERVICE: server
#   REGION: us-east-1


# jobs:
#   build:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: 'read'
#       id-token: 'write'

#     steps:
#     - uses: 'actions/checkout@v3'

#     #####################################################################################################

#     - id: QEMU
#       name: Set up QEMU
#       uses: docker/setup-qemu-action@v2

#     - id: BUILDx
#       name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v2

#     - id: Docker_Auth
#       name: Login to Docker
#       uses: docker/login-action@v2
#       with:
#         registry: us-east-1-docker.pkg.dev
#         username: _json_key
#         password: ${{ secrets.GOOGLE_CREDENTIALS }}

  
#     - name: Build and Push Docker Image
#       uses: docker/build-push-action@v3
#       with:
#         context: server
#         load: true
#         tags: |
#               us-east1-docker.pkg.dev/acmahaja/merntest/server:latest
#               us-east1-docker.pkg.dev/merntest/merntest/server:${{ steps.image-tags.outputs.sha }}


#     - name: Image digest
#       run: echo ${{ steps.docker_build.outputs }}

#     #####################################################################################################

#   deploy:
#     needs:
#     - build
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       id-token: write
    
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v3

#       - name: 'Authenticate to Google Cloud'
#         uses: 'google-github-actions/auth@v1'
#         with:
#           credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

#       - name: Deploy to Cloud Run
#         uses: 'google-github-actions/deploy-cloudrun@v0'
#         with:
#           region: ${{secrets.REGION}}
#           project: ${{secrets.PROJECT_ID}}
#           service: 'server'
#           image: 'us-east1-docker.pkg.dev/acmahaja/merntest/server:latest'

#       - name: 'Use output'
#         run: 'curl "${{ steps.deploy.outputs.url }}"'
