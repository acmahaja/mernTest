name: deploy
on: [push]

env:
  SERVICE: server
  REGION: us-east-1


jobs:
  deploy-server:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: 'actions/checkout@v3'

    #####################################################################################################

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
  
    - name: Build Docker Image
      uses: docker/build-push-action@v3
      with:
        context: server
        push: true
        tags: user/app:latest

    #####################################################################################################

    - name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

    - name: Deploy to Cloud Run
      uses: 'google-github-actions/deploy-cloudrun@v0'
      with:
        region: ${{secrets.REGION}}
        project: ${{secrets.PROJECT_ID}}
        service: 'server'
        image: 'docker.io/library/user/app:latest'

    - name: 'Use output'
      run: 'curl "${{ steps.deploy.outputs.url }}"'
