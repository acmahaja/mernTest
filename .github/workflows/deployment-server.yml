name: deploy
on: [push]

env:
  SERVICE: server
  REGION: us-east-1


jobs:
  deploy-server:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: 'actions/checkout@v3'


    - name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}


    - name: Build and push
      uses: docker/build-push-action@v3
      with:
        context: server
        push: true
        tags: user/app:latest


    # - name: Build Docker image
    #   run: docker build -t ${{secrets.PROJECT_ID }}:$GITHUB_RUN_ID ./server


    # - name: Push Docker image
    #   run: docker push ${{secrets.PROJECT_ID }}:$GITHUB_RUN_ID

    # - name: Deploy to Cloud Run
    #   working-directory: server
    #   run: |-
    #     gcloud run deploy ${{ env.SERVICE }} \
    #       --region ${{ env.REGION }} \
    #       --image gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{  github.sha }} \
    #       --platform "managed" \
    #       --quiet