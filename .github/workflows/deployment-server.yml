name: deploy
on: [push]

env:
  SERVICE: server
  REGION: us-east-1


jobs:
  deploy-server:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: 'actions/checkout@v3'


    - name: 'Authenticate to Google Cloud'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}


    - name: Build Docker Image
      uses: docker/build-push-action@v2
      with:
        context: server
        push: false
        tags: user/app:latest


    # - name: Build Docker image
    #   run: docker build -t ${{secrets.PROJECT_ID }}:$GITHUB_RUN_ID ./server


    # - name: Push Docker image
    #   run: docker push ${{secrets.PROJECT_ID }}:$GITHUB_RUN_ID

    - name: Deploy to Cloud Run
      uses: 'google-github-actions/deploy-cloudrun@v0'
      with:
        service: 'server'
        image: 'docker.io/library/user/app:latest'

    - name: 'Use output'
      run: 'curl "${{ steps.deploy.outputs.url }}"'
